---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/source.toolkit.fluxcd.io/helmrepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: velero-ui
  namespace: cozy-fluxcd
spec:
  interval: 1h
  url: https://helm.otwld.com
---
apiVersion: v1
kind: Namespace
metadata:
  name: velero-ui
  labels:
    app.kubernetes.io/name: velero-ui
    app.kubernetes.io/instance: velero-ui
    ingress.svc.egress: allow # <--- opt-in label for ingress-controller traffic
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/external-secrets/external-secrets/refs/heads/main/config/crds/bases/external-secrets.io_externalsecrets.yaml
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: es-velero-ui-passphrase
  namespace: velero-ui
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: infisical
  target:
    name: velero-ui-passphrase
    creationPolicy: Owner
  data:
    - secretKey: pass_phrase
      remoteRef:
        key: /VELERO_UI/PASS_PHRASE
---
# OAuth/OIDC client credentials for Authentik
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: es-velero-ui-oidc
  namespace: velero-ui
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: infisical
  target:
    name: velero-ui-oidc
    creationPolicy: Owner
  data:
    - secretKey: client_id
      remoteRef:
        key: /VELERO_UI/OIDC_CLIENT_ID
    - secretKey: client_secret
      remoteRef:
        key: /VELERO_UI/OIDC_CLIENT_SECRET
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: velero-ui
  namespace: velero-ui
automountServiceAccountToken: true
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: velero-ui
  namespace: cozy-velero
rules:
  - apiGroups: ["velero.io"]
    resources:
      - backups
      - backuprepositories
      - backupstoragelocations
      - deletebackuprequests
      - podvolumebackups
      - podvolumerestores
      - restores
      - schedules
      - serverstatusrequests
      - volumesnapshotlocations
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: [""]
    resources:
      - secrets
      - pods
      - pods/status
      - pods/log
      - persistentvolumeclaims
      - services
      - events
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: velero-ui
  namespace: cozy-velero
subjects:
  - kind: ServiceAccount
    name: velero-ui
    namespace: velero-ui
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: velero-ui
---
# Allow velero-ui to read cluster-scoped discovery info (namespaces, nodes, etc.)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: velero-ui-view
subjects:
  - kind: ServiceAccount
    name: velero-ui
    namespace: velero-ui
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: view
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: velero-ui
  namespace: velero-ui
spec:
  interval: 1h
  chart:
    spec:
      chart: velero-ui
      version: 0.14.0
      sourceRef:
        kind: HelmRepository
        name: velero-ui
        namespace: cozy-fluxcd
      interval: 10m
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    image:
      repository: otwld/velero-ui
      tag: "0.10.1@sha256:d52893e4a4976ccc7e4c6830cf8b1d4e5125a1bdcac38f7c1f65f201479bffc3"

    serviceAccount:
      create: false
      name: velero-ui

    rbac:
      create: false
      clusterAdministrator: false

    configuration:
      general:
        veleroNamespace: cozy-velero
        secretPassPhrase:
          useSecret: true
          existingSecret: velero-ui-passphrase
          key: pass_phrase

    # Authentik via generic OIDC/OAuth2
    env:
      - name: BASIC_AUTH_ENABLED
        value: "false"
      - name: OAUTH_AUTH_ENABLED
        value: "true"
      - name: OAUTH_NAME
        value: "Authentik"
      - name: OAUTH_AUTHORIZATION_URL
        value: "https://auth.${DOMAIN}/application/o/authorize/"
      - name: OAUTH_TOKEN_URL
        value: "https://auth.${DOMAIN}/application/o/token/"
      - name: OAUTH_USER_INFO_URL
        value: "https://auth.${DOMAIN}/application/o/userinfo/"
      - name: OAUTH_OAUTH_SCOPE
        value: "openid profile email"
      - name: OAUTH_REDIRECT_URI
        value: "https://velero.${DOMAIN}/login"
      - name: OAUTH_GROUP_CLAIM
        value: "groups"
      - name: OAUTH_CLIENT_ID
        valueFrom:
          secretKeyRef:
            name: velero-ui-oidc
            key: client_id
      - name: OAUTH_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: velero-ui-oidc
            key: client_secret

    ingress:
      enabled: true
      className: tenant-root
      annotations:
        external-dns.alpha.kubernetes.io/target: ${CLOUDFLARE_TUNNEL_TARGET}
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
        external-dns.alpha.kubernetes.io/hostname: "velero.${DOMAIN}"
        nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
        nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
        nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
        nginx.ingress.kubernetes.io/proxy-buffering: "off"
        nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
        nginx.ingress.kubernetes.io/auth-url: "http://authentik-server.authentik.svc.cozy.local/outpost.goauthentik.io/auth/nginx"
        nginx.ingress.kubernetes.io/auth-signin: "https://auth.${DOMAIN}/outpost.goauthentik.io/start?rd=$scheme://$http_host$escaped_request_uri"
        nginx.ingress.kubernetes.io/auth-response-headers: "Set-Cookie,X-authentik-username,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-groups,X-authentik-jwt,X-authentik-meta"
        nginx.ingress.kubernetes.io/auth-snippet: |
          proxy_set_header X-Forwarded-Host $http_host;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Forwarded-Uri $request_uri;
          proxy_set_header X-Original-Method $request_method;
      hosts:
        - host: velero.${DOMAIN}
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: wildcard-le-tls-cert
          hosts:
            - velero.${DOMAIN}

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi
