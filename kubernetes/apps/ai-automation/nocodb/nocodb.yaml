---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/source.toolkit.fluxcd.io/gitrepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: nocodb
  namespace: cozy-fluxcd
spec:
  interval: 1h
  ref:
    commit: 06173d1b65e88d289dc63b342caaa615fb8080cd
  url: https://github.com/nocodb/nocodb.git
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: es-nocodb-config
  namespace: ai-automation
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: infisical
  target:
    name: nocodb
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          reloader.stakater.com/auto: "true"
      data:
        NC_AUTH_JWT_SECRET: "{{ .jwt_secret }}"
        NC_DB_JSON: |
          {
            "client": "pg",
            "connection": {
              "host": "ai-automation-rw.ai-automation.svc.cozy.local",
              "port": 5432,
              "database": "nocodb",
              "user": "ai-automation-cnpg",
              "password": {{ .cnpg_password | toJson }},
              "ssl": false
            }
          }
        NC_ADMIN_EMAIL: "{{ .admin_email }}"
        NC_ADMIN_PASSWORD: "{{ .admin_password }}"
        MINIO_ROOT_USER: "{{ .minio_access_key }}"
        MINIO_ROOT_PASSWORD: "{{ .minio_secret_key }}"
        NC_S3_BUCKET_NAME: "nocodb-data"
        NC_S3_ACCESS_KEY: "{{ .minio_access_key }}"
        NC_S3_ACCESS_SECRET: "{{ .minio_secret_key }}"
        NC_S3_ENDPOINT: "{{ .minio_hostname }}"
        NC_S3_REGION: "us-east-1"
        NC_S3_FORCE_PATH_STYLE: "true"
        NC_DISABLE_TELE: "true"
  data:
    - secretKey: cnpg_username
      remoteRef:
        key: /AI_AUTOMATION/CNPG_USERNAME
    - secretKey: cnpg_password
      remoteRef:
        key: /AI_AUTOMATION/CNPG_PASSWORD
    - secretKey: minio_access_key
      remoteRef:
        key: /AI_AUTOMATION/NOCODB_MINIO_ACCESSKEY
    - secretKey: minio_secret_key
      remoteRef:
        key: /AI_AUTOMATION/NOCODB_MINIO_SECRETKEY
    - secretKey: minio_hostname
      remoteRef:
        key: /AI_AUTOMATION/S3_HOSTNAME
    - secretKey: jwt_secret
      remoteRef:
        key: /AI_AUTOMATION/NOCODB_AUTH_JWT_SECRET
    - secretKey: admin_email
      remoteRef:
        key: /AI_AUTOMATION/NOCODB_ADMIN_EMAIL
    - secretKey: admin_password
      remoteRef:
        key: /AI_AUTOMATION/NOCODB_ADMIN_PASSWORD
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/postgresql.cnpg.io/database_v1.json
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
  name: nocodb-db
  namespace: ai-automation
spec:
  cluster:
    name: ai-automation
  name: nocodb
  owner: ai-automation-cnpg
  ensure: present
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nocodb
  namespace: ai-automation
spec:
  interval: 1h
  chart:
    spec:
      chart: charts/nocodb
      sourceRef:
        kind: GitRepository
        name: nocodb
        namespace: cozy-fluxcd
      interval: 10m
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  driftDetection:
    mode: enabled
  values:
    replicaCount: 1

    podAnnotations:
      reloader.stakater.com/auto: "true"

    image:
      repository: nocodb/nocodb
      tag: 0.301.2@sha256:d3aba4f7e89bd18fc01d6853eea0fa82476b161a678f7f0ff52380f4c52bb87f
      pullPolicy: IfNotPresent

    extraEnvs:
      NC_PUBLIC_URL: https://nocodb.${DOMAIN}
      TZ: ${TZ}

    extraSecretEnvs: null

    service:
      type: ClusterIP
      annotations:
        external-dns.alpha.kubernetes.io/internal: "true"
        external-dns.alpha.kubernetes.io/hostname: "nocodb.${DOMAIN}"
        external-dns.alpha.kubernetes.io/target: "cluster-ingress.${DOMAIN}"
      port: 8080

    ingress:
      enabled: true
      className: tenant-root
      port: 8080
      annotations:
        external-dns.alpha.kubernetes.io/target: ${CLOUDFLARE_TUNNEL_TARGET}
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
        external-dns.alpha.kubernetes.io/hostname: "nocodb.${DOMAIN}"
        nginx.ingress.kubernetes.io/auth-url: "http://authentik-server.authentik.svc.cozy.local/outpost.goauthentik.io/auth/nginx"
        nginx.ingress.kubernetes.io/auth-signin: "https://auth.${DOMAIN}/outpost.goauthentik.io/start?rd=$scheme://$http_host$escaped_request_uri"
        nginx.ingress.kubernetes.io/auth-response-headers: "Set-Cookie,X-authentik-username,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-groups,X-authentik-jwt,X-authentik-meta"
        nginx.ingress.kubernetes.io/auth-snippet: |
          proxy_set_header X-Forwarded-Host $http_host;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Forwarded-Uri $request_uri;
          proxy_set_header X-Original-Method $request_method;
      hosts:
        - host: nocodb.${DOMAIN}
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: wildcard-le-tls-cert
          hosts:
            - nocodb.${DOMAIN}

    storage:
      enabled: false

    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        memory: 1Gi

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: OnRootMismatch

    securityContext:
      runAsNonRoot: true
      allowPrivilegeEscalation: false
