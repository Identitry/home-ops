---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: es-deepeval-mcp
  namespace: ai-automation
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: infisical
  target:
    name: deepeval-mcp
    template:
      type: Opaque
      metadata:
        labels:
          reloader.stakater.com/auto: "true"
    creationPolicy: Owner
  data:
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: /AI_AUTOMATION/DEEPEVAL_MCP_OPENAPI_API_KEY
    - secretKey: API_KEYS
      remoteRef:
        key: /AI_AUTOMATION/DEEPEVAL_MCP_API_KEYS
---
# HelmRelease med BJWs app-template
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: deepeval-mcp
  namespace: ai-automation
  annotations:
    lineage.cozystack.io/ignore: "true"
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: cozy-fluxcd
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      deepeval-mcp:
        annotations:
          reloader.stakater.com/match: deepeval-mcp
        containers:
          app:
            image:
              repository: ghcr.io/identitry/deepeval-mcp
              tag: 3.8.0@sha256:1cd92065fc6c9938a1024c18f1af75ec47f7caa8dea97d6284466473af62cc70
              pullPolicy: IfNotPresent
            envFrom:
              - secretRef:
                  name: deepeval-mcp
            resources:
              requests:
                cpu: 200m
                memory: 1Gi
              limits:
                cpu: 2
                memory: 4Gi
            ports:
              - name: mcp
                containerPort: 8000

    service:
      deepeval-mcp:
        controller: deepeval-mcp
        ports:
          mcp:
            port: 8000
            targetPort: mcp
