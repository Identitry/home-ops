---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: es-deepeval-mcp
  namespace: ai-automation
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: infisical
  target:
    name: deepeval-mcp
    template:
      type: Opaque
      metadata:
        labels:
          reloader.stakater.com/auto: "true"
    creationPolicy: Owner
  data:
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: /AI_AUTOMATION/DEEPEVAL_MCP_OPENAPI_API_KEY
    - secretKey: API_KEYS
      remoteRef:
        key: /AI_AUTOMATION/DEEPEVAL_MCP_API_KEYS
---
# HelmRelease med BJWs app-template
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: deepeval-mcp
  namespace: ai-automation
  annotations:
    lineage.cozystack.io/ignore: "true"
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: cozy-fluxcd
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      deepeval-mcp:
        annotations:
          reloader.stakater.com/match: deepeval-mcp
        containers:
          app:
            image:
              repository: ghcr.io/identitry/deepeval-mcp
              tag: 3.7.5@sha256:e94e5d367e3e37a2f6d1d73a29cb7d043825c2dc3b39b04cfdc881df1fc82f99
              pullPolicy: IfNotPresent
            envFrom:
              - secretRef:
                  name: deepeval-mcp
            resources:
              requests:
                cpu: 200m
                memory: 1Gi
              limits:
                cpu: 2
                memory: 4Gi
            ports:
              - name: mcp
                containerPort: 8000

    service:
      deepeval-mcp:
        controller: deepeval-mcp
        ports:
          mcp:
            port: 8000
            targetPort: mcp
