---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/source.toolkit.fluxcd.io/helmrepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: qdrant
  namespace: cozy-fluxcd
spec:
  interval: 1h
  url: https://qdrant.github.io/qdrant-helm
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: qdrant
  namespace: ai-automation
spec:
  interval: 1h
  chart:
    spec:
      chart: qdrant
      version: 1.16.2
      sourceRef:
        kind: HelmRepository
        name: qdrant
        namespace: cozy-fluxcd
      interval: 10m
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    podAnnotations:
      secret.reloader.stakater.com/reload: wildcard-le-tls-cert

    image:
      repository: qdrant/qdrant
      tag: v1.16.2
      digest: sha256:0fb8897412abc81d1c0430a899b9a81eb8328aa634e7242d1bc804c1fe8fe863
      pullPolicy: IfNotPresent
      useUnprivilegedImage: false

    persistence:
      accessModes:
        - ReadWriteOnce
      size: 10Gi
      storageClassName: local

    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi

    config:
      cluster:
        enabled: false

    service:
      type: ClusterIP
      annotations:
        external-dns.alpha.kubernetes.io/internal: "true"
        external-dns.alpha.kubernetes.io/hostname: "qdrant.${DOMAIN}"
        external-dns.alpha.kubernetes.io/target: "cluster-ingress.${DOMAIN}"

    ingress:
      enabled: true
      ingressClassName: tenant-root
      annotations:
        external-dns.alpha.kubernetes.io/target: ${CLOUDFLARE_TUNNEL_TARGET}
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
        external-dns.alpha.kubernetes.io/hostname: "qdrant.${DOMAIN}"
        nginx.ingress.kubernetes.io/auth-url: "http://authentik-server.authentik.svc.cozy.local/outpost.goauthentik.io/auth/nginx"
        nginx.ingress.kubernetes.io/auth-signin: "https://auth.${DOMAIN}/outpost.goauthentik.io/start?rd=$scheme://$http_host$escaped_request_uri"
        nginx.ingress.kubernetes.io/auth-response-headers: "Set-Cookie,X-authentik-username,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-groups,X-authentik-jwt,X-authentik-meta"
        nginx.ingress.kubernetes.io/auth-snippet: |
          proxy_set_header X-Forwarded-Host $http_host;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Forwarded-Uri $request_uri;
          proxy_set_header X-Original-Method $request_method;
      hosts:
        - host: qdrant.${DOMAIN}
          paths:
            - path: /
              pathType: Prefix
              servicePort: 6333
      tls:
        - hosts:
            - qdrant.${DOMAIN}
          secretName: wildcard-le-tls-cert
