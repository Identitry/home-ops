---
# yaml-language-server: $schema=https://raw.githubusercontent.com/external-secrets/kubernetes-external-secrets/main/deploy/crds/external-secrets.io_externalsecrets.yaml
# External secret that contains the PKCS#12 password for the PKCS12 file created with the Wild Card cert.
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: es-wildcard-cert-pkcs12-pass
  namespace: tenant-root
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: infisical
  target:
    name: wildcard-cert-pkcs12-pass
    creationPolicy: Owner
  data:
    - secretKey: password
      remoteRef:
        key: /CERT_MANAGER/WILDCARD_CERT_PKCS12_PASS
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/jetstack/cert-manager/main/deploy/crds/cert-manager.io_certificates.yaml
# Wildcard TLS certificate for *.myk8s.se and myk8s.se, issued by Let's Encrypt.
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wildcard-le-tls-cert
  namespace: tenant-root
spec:
  dnsNames:
    - "*.${DOMAIN}"
    - "${DOMAIN}"
  secretName: wildcard-le-tls-cert
  secretTemplate:
    annotations:
      reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
      reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true"
      reflector.v1.k8s.emberstack.com/allowed-namespaces: "media, blocky, authentik, atuin, peanut"
      reflector.v1.k8s.emberstack.com/reflection-auto-namespaces: "media, blocky, authentik, atuin, peanut"
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  keystores:
    pkcs12:
      create: true
      passwordSecretRef:
        name: wildcard-cert-pkcs12-pass
        key: password
      profile: Modern2023
