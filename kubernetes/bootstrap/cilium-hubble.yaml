---
# Cilium patch to enable Hubble UI and Relay with Ingress.
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cilium
  namespace: cozy-cilium
spec:
  interval: 5m0s
  values:
    hubble:
      enabled: true
      relay: { enabled: true }
      ui:
        enabled: true
        ingress:
          enabled: true
          className: tenant-root
          hosts: ["hubble.${DOMAIN}"]
          tls:
            - hosts: ["hubble.${DOMAIN}"]
              secretName: wildcard-le-tls-cert
          annotations:
            external-dns.alpha.kubernetes.io/target: ${CLOUDFLARE_TUNNEL_TARGET}
            external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
            external-dns.alpha.kubernetes.io/hostname: "hubble.${DOMAIN}"
            # --- Authentik forward-auth (NGINX Ingress) ---
            nginx.ingress.kubernetes.io/auth-url: "http://authentik-server.authentik.svc.cozy.local/outpost.goauthentik.io/auth/nginx"
            nginx.ingress.kubernetes.io/auth-signin: "https://auth.${DOMAIN}/outpost.goauthentik.io/start?rd=$scheme://$http_host$escaped_request_uri"
            nginx.ingress.kubernetes.io/auth-response-headers: "Set-Cookie,X-authentik-username,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-groups,X-authentik-jwt,X-authentik-meta"
            nginx.ingress.kubernetes.io/auth-snippet: |
              proxy_set_header X-Forwarded-Host $http_host;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header X-Forwarded-Uri $request_uri;
              proxy_set_header X-Original-Method $request_method;
