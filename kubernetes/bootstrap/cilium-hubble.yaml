---
# Cilium Patch to enable Cilium Hubble, Hubble Relay and Hubble UI with ingress and authentik auth.
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cilium
  namespace: cozy-cilium
spec:
  interval: 5m
  chart:
    spec:
      chart: cozy-cilium
      reconcileStrategy: Revision
      sourceRef:
        kind: HelmRepository
        name: cozystack-system
        namespace: cozy-system
      valuesFiles:
        - values.yaml
        - values-talos.yaml
        - values-kubeovn.yaml
      version: ">= 0.0.0-0"
  values:
    hubble:
      enabled: true
      relay:
        enabled: true
        extraArgs:
          - --peer=192.168.222.21:4244
          - --peer=192.168.222.22:4244
        config:
          peer:
            - "192.168.222.21:4244"
            - "192.168.222.22:4244"
      peerService:
        enabled: false
        clusterDomain: cozy.local
        name: hubble-peer
        namespace: cozy-cilium
        port: 443
        targetPort: 4244
        selector:
          k8s-app: cilium
      ui:
        enabled: true
        ingress:
          enabled: true
          className: tenant-root
          hosts:
            - "hubble.${DOMAIN}"
          tls:
            - hosts:
                - "hubble.${DOMAIN}"
              secretName: wildcard-le-tls-cert
          annotations:
            external-dns.alpha.kubernetes.io/target: ${CLOUDFLARE_TUNNEL_TARGET}
            external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
            external-dns.alpha.kubernetes.io/hostname: "hubble.${DOMAIN}"
            nginx.ingress.kubernetes.io/auth-url: "http://authentik-server.authentik.svc.cozy.local/outpost.goauthentik.io/auth/nginx"
            nginx.ingress.kubernetes.io/auth-signin: "https://auth.${DOMAIN}/outpost.goauthentik.io/start?rd=$scheme://$http_host$escaped_request_uri"
            nginx.ingress.kubernetes.io/auth-response-headers: "Set-Cookie,X-authentik-username,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-groups,X-authentik-jwt,X-authentik-meta"
            nginx.ingress.kubernetes.io/auth-snippet: |
              proxy_set_header X-Forwarded-Host $http_host;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header X-Forwarded-Uri $request_uri;
              proxy_set_header X-Original-Method $request_method;
---
# Network policy for allowing ingress into hubble UI.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hubble-ui-allow-from-nginx
  namespace: cozy-cilium
spec:
  podSelector:
    matchLabels:
      k8s-app: hubble-ui
  policyTypes: ["Ingress"]
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: tenant-root
      podSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8081
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hubble-ui-egress-relay-dns
  namespace: cozy-cilium
spec:
  podSelector:
    matchLabels:
      k8s-app: hubble-ui
  policyTypes: ["Egress"]
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: cozy-cilium
      podSelector:
        matchLabels:
          k8s-app: hubble-relay
    ports:
    - protocol: TCP
      port: 4245
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns   # (byt till app.kubernetes.io/name: coredns om du anv√§nder det)
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hubble-relay-allow-from-ui
  namespace: cozy-cilium
spec:
  podSelector:
    matchLabels:
      k8s-app: hubble-relay
  policyTypes: ["Ingress"]
  ingress:
  - from:
    - podSelector:
        matchLabels:
          k8s-app: hubble-ui
    ports:
    - protocol: TCP
      port: 4245
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: hubble-relay-egress
  namespace: cozy-cilium
spec:
  endpointSelector:
    matchLabels:
      k8s-app: hubble-relay
  egress:
    - toEndpoints:
        - matchLabels:
            k8s-app: cilium
      toPorts:
        - ports:
            - port: "4244"
              protocol: TCP
    - toServices:
        - k8sService:
            namespace: kube-system
            serviceName: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: ANY
          rules:
            dns:
              - matchPattern: "*"
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: hubble-relay-ingress
  namespace: cozy-cilium
spec:
  endpointSelector:
    matchLabels:
      k8s-app: hubble-relay
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s-app: hubble-ui
      toPorts:
        - ports:
            - port: "4245"
              protocol: TCP
